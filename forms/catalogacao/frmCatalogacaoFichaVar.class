<?
class frmCatalogacaoFichaVar extends MFormAjax
{
    public $subficha;
    public $ficha;
    public $obra;
    public $etiqueta;

	var $objSimples;

    function __construct($subficha)
    {
       $this->subficha = $subficha;
       parent::__construct($subficha->titulo);
       
       $this->page->AddJsCode(file_get_contents(dirname(__FILE__) . '/../js/frmPreCatalogacao.js'));  
        
       // Botão 'fechar', direcionando para o handler biblioteca/main/catalogacao
	   $this->SetClose($this->manager->GetActionURL($module, 'main:catalogacao'));   
		    
    }


    function CreateFields()
    {
		$this->obra = $this->manager->getBusiness('biblioteca','obra',$this->subficha->idobra);
        $this->ficha = $this->manager->getBusiness('biblioteca','ficha');
        $this->etiqueta = $this->manager->getBusiness('biblioteca','etiqueta');
        $etiqueta = $this->etiqueta->getByFicha($this->subficha->idficha,$this->subficha->idsubficha);

		$array = array( 
              new MHiddenField('hidFieldList',''),
              new MHiddenField('idEtiqueta',''),
              array(
//            new MSelection('selEtiqueta','','Etiqueta', $etiqueta->chunkResultMany(0,array(1,2),'S','&nbsp;')),
		      new MSelection('selEtiqueta','','Etiqueta'),
              new MTextField('txtOcorrencia','','Ocorrência',3),
              new MButton('btnEdit','Editar'),
              new MButton('btnChoose','Outra etiqueta'),
              new MTextLabel('lblRep','Obs: Usar o campo Ocorrência apenas para etiquetas repetitivas [r]',' ', 'blue')
              )
        );
        $this->setFields($array);
        
        $tipo = $this->getFormValue('tipo');
		if ($tipo == 'indice')
		{
		   $buttons = array(
           new MButton('btnPost', '<b>Gravar</b>'),
		   //new MButton('btnVoltarPesq','<b>Voltar</b>')
		   );		   
           
	       $this->SetButtons($buttons);
	       //$this->SetFieldAttr('btnChoose','visible', false);
	       //$this->SetbuttonAttr('btnChoose','visible',false);
		}
				
		if($this->GetFieldValue('txtOcorrencia') == null)
		{
			$this->setFieldValue('txtOcorrencia','1');
		}

		$this->SetFieldAttr('selEtiqueta','options', $etiqueta->chunkResultMany(0,array(1,2),'S','&nbsp;'));
		//$this->SetFieldAttr('selEtiqueta','options', $etiqueta->chunkResultMany(0,array(1,2),'S','&nbsp;'));
		$this->setFieldAttr('btnChoose','visible',false);
        $this->defaultButton = false;

		//se vier da pesquisa por termo específico
		if($this->GetFormValue('event') == 'PesquisaCatalog')
		{
			$this->btnEdit_click();
		}
	}


    function addInputFields($idEtiqueta, $ocorrencia,$tag)
    {
    	//$this->setButtonAttr('btnPost','visible',false);   	   	
        $this->setFieldAttr('btnEdit','visible',false);
        $this->setFieldAttr('lblRep','visible',false);
        $this->setFieldAttr('btnChoose','visible',true);
        $this->setFieldAttr('selEtiqueta','readonly',true);
        $this->setFieldAttr('txtOcorrencia','readonly',true);
        $fList = '';
        $existeCampoVariavel = false;

        $obj = new MDummy();
        $fields = new MHContainer();
        $indicadores = $this->etiqueta->getIndicadores($idEtiqueta);
		$listaIndicadores = array();
		foreach ($indicadores as $i=>$ind)
        {
            if ($ind != 0)
            { 
                $obj->indicador = $i;
                $obj->idopcao = $this->etiqueta->getOpcao('IN' . $i);
                $field = $this->ficha->getInputFieldInd($this->subficha->idsubficha, $obj);
                $fList .= ($fList != '' ? ',' : '') . $field->getName();
                $field->formMode = 2;
                $indicador = $this->obra->getIndicador($idEtiqueta,$i,$ocorrencia);
                if (!$indicador->eof)
                {
                    $field->setValue($indicador->fields('conteudo'));
                    $existeCampoVariavel = true;
                }
                $fields->addControl($field);

				//lista para validators
				$listaIndicadores[] = $field->getName();
            }
        } 
        $this->addField($fields);

		//validators
		for($i = 0; $i < count($listaIndicadores); $i++)
		{
			$this->AddValidator(new RequiredValidator($listaIndicadores[$i]));
		}

        $campo = $this->ficha->getCampo($this->subficha->idficha,$this->subficha->idsubficha, $idEtiqueta, $ocorrencia);
        while (! $campo->eof)
        {
            $obj = $campo->getRowObject();
            $field = $this->ficha->getInputFieldVar($this->subficha->idsubficha,$obj,$tag);
            $fList .= ($fList != '' ? ',' : '') . $field->getName();
            $field->formMode = 2;
            $material = $this->obra->getMaterial($idEtiqueta,$obj->subcampo,$ocorrencia);
			if (!$material->eof)
            {
                if ($field->className == 'mmultitextfield3')
                {
                    $array = $material->chunkResultMany(0,array(1,2),'');
                    $field->setCodeValue($array);
                }
                else
                {
                    $field->setValue($material->fields('conteudo'));
                }
            }
            $this->addField($field);
            $campo->moveNext(); 
        } 
        
        $this->setFieldValue('hidFieldList', $fList);
        $this->setFieldValue('idEtiqueta', $idEtiqueta);
        
		$tipo = $this->getFormValue('tipo');
        
		if ($tipo != 'indice')
        {
           $url = $this->manager->getActionUrl('biblioteca','ajaxhandler');
		   $buttons = array(
           new MButton('btnPost', '<b>Gravar</b>'),
		   new MButton('btnAtualizarCutter','<b>Atualizar Cutter</b>')
           );
                      
           $this->SetButtons($buttons);

        }
		    
        if ($tag = '245' and $existeCampoVariavel)
        {
            $this->setButtonAttr('btnAtualizarCutter','visible',true);
        }
        else 
        {
            $this->setButtonAttr('btnAtualizarCutter','visible',false);   
        }
        
		
		//$this->setButtonAttr('btnVoltarPesq','visible',false);
		//$this->setButtonAttr('btnPost','visible',false);
    }


    function btnEdit_click()
    {
		global $MIOLO, $module, $self, $theme, $action, $page;
	
		
		$idEtiqueta = $this->getFormValue('selEtiqueta');
		$etiqueta = $this->etiqueta->GetById($idEtiqueta);
		$tag = $etiqueta->tag;

		$ocorrencia = MUtil::NVL($this->getFormValue('txtOcorrencia'),'0');
		$etiqueta = $this->etiqueta->getById($idEtiqueta);

		if ($this->etiqueta->temRepeticoes)
		{
            if ($ocorrencia == '0')
            {
                $this->AddError('Em etiquetas com repetições deve-se informar o número da ocorrência.');
                return;
	        }
		}
		else
	    {
		    $ocorrencia = '1';
			$this->SetFieldValue('txtOcorrencia', '1');
        }
		$this->addInputFields($idEtiqueta, $ocorrencia, $tag);

		$tipo = $this->getFormValue('tipo');
		if ($tipo == 'indice')
		{
			$consultarpor = $this->getFormValue('consultarpor');
			$filtro = $this->getFormValue('filtro');
			$consulta = $this->getFormValue('consulta');
			$termo = $this->getFormValue('termo');
			$unidade = $this->getFormValue('unidade');
			$tipo = $this->getFormValue('tipo');
			$page = $this->getFormValue('page');
	
			$endereco = $MIOLO->GetActionURL($module, 'main:pesquisaindice', $filtro, Array('event'=>'PesquisaDetalhada','consultarpor'=>$consultarpor,'consulta'=>$consulta,'termo'=>$termo,'unidade'=>$unidade,'tipo'=>$tipo,'page'=>$page));
		
			//$this->setButtonAttr('btnVoltarPesq','visible',true);
			$this->setButtonAttr('btnVoltarPesq','action',$endereco);
		}

		//valores defaults
		$sub = $this->subficha->idsubficha;
		if($tag == '040')
		{
			if($this->GetFieldValue($sub . '_27_a') == '')
			{
				$this->SetFieldValue($sub . '_27_a', 'UFJF');
			}
		}
		if($tag == '100')
		{
			if($this->GetFieldValue($sub . '_IND_1') == '')
			{
				$this->SetFieldValue($sub . '_IND_1', '1');
			}
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', ' ');
			}
		}
		if($tag == '245')
		{
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', '0');
			}
		}
		if($tag == '490')
		{
			if($this->GetFieldValue($sub . '_IND_1') == '')
			{
				$this->SetFieldValue($sub . '_IND_1', '0');
			}
		}
		if($tag == '600')
		{
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', '4');
			}
		}
		if($tag == '610')
		{
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', '4');
			}
		}
		if($tag == '611')
		{
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', '4');
			}
		}
		if($tag == '630')
		{
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', '4');
			}
		}
		if($tag == '650')
		{
			if($this->GetFieldValue($sub . '_IND_1') == '')
			{
				$this->SetFieldValue($sub . '_IND_1', '#');
			}
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', '4');
			}
		}
		if($tag == '651')
		{
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', '4');
			}
		}
		if($tag == '700')
		{
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', '#');
			}
		}
		if($tag == '711')
		{
			if($this->GetFieldValue($sub . '_IND_2') == '')
			{
				$this->SetFieldValue($sub . '_IND_2', '#');
			}
		}
    }


    function btnChoose_click()
    {
		//default para os campos
		$this->setFieldValue('txtOcorrencia','1');

		if($this->GetFormValue('selEtiqueta') != null)
		{
			$default = $this->etiqueta->GetByTag(substr($this->GetFormValue('selEtiqueta'), 0, 3));
			$this->SetFieldValue('selEtiqueta',$default->idEtiqueta);
		}
    }


    function btnPost_click()
    {
		global $MIOLO, $module;

		$this->objSimples = $MIOLO->GetBusiness($module,'pesquisasimples');

		$idEtiqueta = $this->getFieldValue('idEtiqueta');
		$tag = $this->getFieldValue('selEtiqueta');
        $ocorrencia = MUtil::NVL($this->getFieldValue('txtOcorrencia'),'1');

		//deleta todos os materiais dessa obra, etiqueta, ocorrencia
		$this->obra->deleteMaterial($idEtiqueta,$ocorrencia);

		$etiqueta_vazia = true;
		$fields = explode(',',$this->getFieldValue('hidFieldList'));
		foreach($fields as $field)
	    {

//			if (!is_null($value = $this->page->request($field)))
//			{
				$value = $this->page->request($field);
                $campo = explode('_',$field);
	            if ($campo[0] == $this->subficha->idsubficha)
		        {
			        if (is_array($value))
				    {
						foreach($value as $i=>$v)
						{
							$t = explode('] [',$v);
							$linha = substr($t[0],1);
							$conteudo = substr($t[1],0,strlen($t[1])-1);
							$conteudo = trim($this->objSimples->RetirarCaracteresEspeciais($conteudo));
							if($conteudo != null)
							{
								$this->obra->saveMaterial($idEtiqueta, $ocorrencia, $campo[2], $linha, $conteudo, $tag);
								$etiqueta_vazia = false;
							}
		                } 
			        }
				    else
					{
                        if ($campo[1] == "IND")
	                    {
		                    $this->obra->saveIndicador($idEtiqueta, $ocorrencia, $campo[2], $value, $tag);
			            }
				        else
					    {
							if($value != null)
							{
								$value = trim($this->objSimples->RetirarCaracteresEspeciais($value));
								$this->obra->saveMaterial($idEtiqueta, $ocorrencia, $campo[2], 1, $value, $tag);
								$etiqueta_vazia = false;
							}
							else //para casos em que é preciso apagar campo da bt_obra
							{
								$this->obra->saveMaterial($idEtiqueta, $ocorrencia, $campo[2], 1, $value, $tag);
							}
                        }
	                }
		        }
//			}
		}

		//se a ocorrencia foi deletada
		if($etiqueta_vazia)
		{
			$this->obra->atualizaOcorrencias($idEtiqueta,$ocorrencia);
		}

		$this->setFieldValue('selEtiqueta',$idEtiqueta);
		$etiqueta = $this->etiqueta->getById($idEtiqueta);
		$this->addInputFields($idEtiqueta,$ocorrencia,$tag);
		//$this->setFieldAttr('btnPost','visible',false);
		
		if ($tag == '245')
		{
		     $this->setButtonAttr('btnAtualizarCutter','visible',true);
		}
				
		//remove o negrito do botão, pois já foi pressionado uma vez
		$this->SetButtonAttr('btnPost','label','Gravar');
	}
	
	function btnAtualizarCutter_click()
	{
	    global $MIOLO, $module;
	    
        $objEtiqueta = $MIOLO->GetBusiness('biblioteca','etiqueta');
        $autor = $this->obra->autor;
        $titulo = $this->obra->titulo;
        $cutter = $objEtiqueta->geraCutter($autor,$titulo,$this->obra->idObra);
        
        if ($cutter != null)
        {
            $this->obra->saveMaterial('52', '1', 'b', '1', $cutter, '090');                                   
        }

	}
}
?>
