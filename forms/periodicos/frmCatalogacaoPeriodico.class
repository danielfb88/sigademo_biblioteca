<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>
<?php
/**
* @package SIGA
* @subpackage Biblioteca
* @author SETEC/MEC
*/

class frmCatalogacaoPeriodico extends Form
{
	public $periodico;
      
   function frmCatalogacaoPeriodico()
   {    
      
        global $MIOLO,$module;

		// Título do Formulário
		$this->Form('Selecionar Periódico');

		//Chama o CreateFileds, etc.
		$this->EventHandler();

		// Botão "enviar" (incluir) não aparece
		$this->defaultButton = false;
		
      // Botão 'fechar', direcionando para o handler biblioteca/main/catalogacao
      $this->SetClose($this->manager->GetActionURL($module, 'main:catalogacao:periodicos'));
   }
   
    function CreateFields()
    {   global $MIOLO;
        $fields = array(
            new MHiddenField('idperiodico',''),
            new MTextField('issn','','ISSN',10),
            new MTextLabel('ou',' -Ou- ','&nbsp;'),
            new LookupTextField('titulo','','Título',45,'Pesquise pelo título')
        );
        // Insere os campos
        $this->SetFields($fields);
        //As 4 propriedades de um lookup
        // module = módulo usado
        // item = A funcao que chama no arquivo classes/lookup.class
        // event = O evento relacionado quando o usuário clica em "acao"
        // related = Os campos retornados após a ação

        $this->SetFieldAttr('titulo','module','biblioteca');
        $this->SetFieldAttr('titulo','item','periodico');
        $this->SetFieldAttr('titulo','event','btnConsulta:click');
        $this->SetFieldAttr('titulo','related','idperiodico');
        
        $this->addButton(new MButton('btnEnviar','Enviar'));
        $this->addButton(new FormButton('btnVoltar', 'Voltar', $MIOLO->GetActionURL($module = $module,"main:catalogacao:periodicos")));
		//Definindo o foco
         if (!($this->GetFieldValue('issn')))
         {
            $this->page->onLoad("MIOLO_GetElementById('issn').focus();");
         }
    }


    // pega os dados que estão no formulário
    function GetData()
    {
        $data = new FormData();
        $data->idperiodico = $this->GetFieldValue('idperiodico');
        $data->issn = $this->GetFieldValue('issn');
        $data->titulo = $this->GetFieldValue('titulo');
        return $data;
    }
    // usada para inserir valores no formulário
    function SetData($data){

        $this->SetFieldValue('titulo',$data->titulo);
        $this->SetFieldValue('issn',$data->issn);
        $this->SetFieldValue('idperiodico',$data->idPeriodico);
    }

    function btnConsulta_click($sender,$idperiodico)
    {
        global $MIOLO,$module;

        $idperiodico = ($idperiodico != '')? $idperiodico : $this->GetFieldValue('idperiodico');

        if($idperiodico!=''){
            $this->periodico = $MIOLO->GetBusiness($module,'periodico');
            $this->periodico->GetById($idperiodico);
            $this->SetData($this->periodico);
            $this->GetData();
        }
    }

    function btnEnviar_click(){
            global $MIOLO,$module;

            if ($this->GetFieldValue('idperiodico') == '')
            {
                if($this->getFieldValue('issn')!=''){
                    $issn = $this->getFieldValue('issn');
                        $this->periodico = $MIOLO->GetBusiness($module,'periodico');
                        $this->periodico->GetByIssn($issn);

                        if($this->periodico->idPeriodico!=null){
                            $this->SetFieldValue('idperiodico',$this->periodico->idPeriodico);
                        }else{
                            $MIOLO->Error("ISSN não cadastrado",'');
                        }
                }else{
                    $MIOLO->Error("Preencha um ISSN cadastrado ou faça uma busca por título",'');
                }
            }
            if($this->GetFieldValue('idperiodico')!=null){
                //global $item;
                $item=$this->getFieldValue('idperiodico');
                $go = $this->manager->getActionURL('biblioteca','main:catalogacao:periodicos:catalogacaoperiodico',$item);
                $this->page->redirect($go);
            }
    }
 }
?>
