<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
* Este arquivo é parte do programa SigaEPT
*
* O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
* termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
* na versão 2 da Licença.
*
* Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
* uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
* Pública Geral GNU/GPL em português para maiores detalhes.
*
* Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
* junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
* www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
* St, Fifth Floor, Boston, MA 02110-1301, USA
*/
?>
<?php
/**
 * @package SIGA
 * @subpackage Biblioteca
 * @author SETEC/MEC
 * @author Daniel Bonfim
 */

class frmImportacao extends MForm {
	private $livroImportacao;

	function __construct() {
		global $MIOLO, $module;
		parent::__construct('Importação Marc para Livro');
		$this->SetClose($this->manager->GetActionURL('biblioteca', 'main:importacao'));
		$this->EventHandler();
	}

	function CreateFields()
	{
		global $MIOLO,$module;

		$fields = array	(
				new MultiLineField('txtObraMarc','','Livro', 25, 20,50,null,null),
		);
		$this->SetFields($fields);

		$buttons = array (
				new MButton('btnEnviar','Enviar'),
		);
		$this->SetButtons($buttons);

		// Business
		$this->livroImportacao = $MIOLO->GetBusiness($module, 'livroImportacao');
	}

	function btnEnviar_click() {
		global $MIOLO, $module;

		$txtObraMarc = $this->GetFormValue('txtObraMarc');

		try {
			$this->livroImportacao->setMarc($txtObraMarc);

		} catch (EMarcException $e) {
			$this->addError($e->getMessage());
		}

		if(!$this->hasErrors()) {
			$msg = null;
			
			$idEditora = $this->livroImportacao->salvarEditora();
			$idAutor = $this->livroImportacao->salvarAutor();
			$idObra = $this->livroImportacao->salvarObra();

			if($idEditora && $idAutor && $idObra) {
				$infos = $this->livroImportacao->getInfo();

				if($infos == null) {
					$msg = "As informações já se encontram cadastradas na base de dados.";
				} else {
					$msg = $infos;
				}

			} else {
				$msg = "Houve um erro ao importar a obra.";
			}
				
			$this->manager->Information($msg, $this->manager->GetActionURL('biblioteca', 'main:catalogacao', null));
		}
	}

}
?>
