<?php
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versão 2 da Licença.
 *
 * Este programa é distribuído na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título “LICENCA.txt”,
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */
?>
<?php
/**
* @package SIGA
* @subpackage Biblioteca
* @author SETEC/MEC
*/

class frmEmpHistExemplar extends MFormAJAX
{
    public $objEmprestimo;
    public $objExemplar;
	public $tombo;
	public $idexemplar;
	public $idEmprestimo;
	public $grid;

	function __construct()
    {   
		global $MIOLO, $action, $module, $objExemplar;

        $this->objExemplar = $MIOLO->getBusiness($module,'exemplar');
        parent::__construct('Histórico de Empréstimos do Exemplar');
        $this->box->AddStyle('padding',"10px");
	    $this->eventHandler();
		$this->defaultButton = false;
		
	    // Botão 'fechar', direcionando para o handler biblioteca/main/emprestimos
		$this->SetClose($this->manager->GetActionURL($module, 'main:emprestimos'));
	}


    function CreateFields()
	{  
		global $MIOLO, $action, $module, $item, $page;

		if (! $this->page->IsPostBack())
		{
			$fields = Array (
				new MTextField('exemplar','','Código do Exemplar',25),
			);
			$this->SetFields($fields);

			$buttons = Array(
				new MButton('btnProcurar', 'Procurar'),
			);
			$this->SetButtons($buttons);

			if (!$item)
			{
				$this->page->onLoad("MIOLO_GetElementById('exemplar').focus();");

				// validators
				$this->AddValidator(new RequiredValidator('exemplar'));
			}
		}
    }



    function btnProcurar_click()
    {
		global $MIOLO, $module, $action, $item;

	// grid com os empréstimos do exemplar
		if ($item==null)
		{
			$this->tombo = $this->getFormValue('exemplar');
			$this->idexemplar = $this->objExemplar->GetIdByTombo($this->tombo);
			$item = $this->$tombo;
		}
		else
		{
			$this->tombo = $item;
			$this->idexemplar = $this->objExemplar->GetIdByTombo($this->tombo);
		}


    
        if (($this->idexemplar)==null)
        {
            $go = $MIOLO->GetActionURL($module,$action);
            $MIOLO->Error('Exemplar não existe', $go);
        }

        else
        {
        $this->setTitle('Histórico de Empréstimos do Exemplar ' . $this->tombo);

		$this->objEmprestimo = $MIOLO->GetBusiness($module,'emprestimo');
		$query = $this->objEmprestimo->SelectEmprestimoHistExemplar($this->idexemplar);



        
        
		$this->idEmprestimo = $query->idemprestimo;
        $this->grid = $this->manager->getUI()->getGrid($module,'gridHistExemp',$query);

		$fields = array(
			$this->grid,
			new MHiddenField('exemplar',$this->tombo)
		);
		$this->setFields($fields);


  //      if (($this->tombo)==null)
    //    {
      //      $go = $MIOLO->GetActionURL($module,$action);
        //    $MIOLO->Error('Exemplar não existe', $go);
     //   }

        

		$buttons = Array(
			new MButton('btnVoltar', 'Voltar', $MIOLO->GetActionURL($module = $module, $action = $action)),
   						);
		$this->SetButtons($buttons);

        $this->SetButtonAttr('btnProcurar','visible',false);
    }
    }

    function ajax_detail($id)
    {
        // this method is called by CPAINT at doDetail execution

		global $MIOLO, $module;
        $log = $MIOLO->GetBusiness($module,'log');
		$opempr = $log->GetOperadorEmprByOperacao($id);
		$opdevol = $log->GetOperadorDevolByOperacao($id);
        $data = array();
        $data[] = "Operador de Empréstimo: " . $opempr[0][0] . " - " . $opempr[0][1];
		if ($opdevol != null)
			$data[] = "Operador de Devolução  : " . $opdevol[0][0] . " - " . $opdevol[0][1];    
        $control = new MTableRaw('',$data);
        $control->setAlternate(true);
        $MIOLO->getTheme()->setAjaxContent($control);
	}


	function btnEdit_click()
	{
		global $MIOLO, $module, $action, $item;

		$fields = array(
			new MTextField('idemprestimo','','Código do Empréstimo',20),
			new MTextField('loginPessoa','','Login do Usuário',20),
			new MTextField('numerodotombo','','Número do Exemplar',20),
			new MTextField('datahoradoemprestimo','','Data/Hora do Empréstimo',20),
			new MTextField('datahoraprevisaodevolucao','','Data/Hora Previsão Devolução',20),
			new MTextField('datahoradadevolucao','','Data/Hora da Devolução',20),
		);
		$this->SetFields($fields);

		$this->setFieldAttr('idemprestimo','readonly',true);
		$this->setFieldAttr('loginPessoa','readonly',true);
		$this->setFieldAttr('numerodotombo','readonly',true);
		
		$this->objEmprestimo = $MIOLO->GetBusiness($module,'emprestimo');
		$emprestimo = $this->objEmprestimo->GetEmprestimoById($item);
		$this->setData($emprestimo);

		$go = $this->manager->GetActionURL($module, $action, $emprestimo->numerodotombo, array('event'=>'btnProcurar:click'));
		
		$buttons = Array(
			new MButton('btnSalvar', 'Salvar'),
			new MButton('btnVoltar', 'Voltar', $go),
		);

		$this->SetButtons($buttons);	
		$this->SetButtonAttr('btnProcurar','visible',false);
		
		if ($emprestimo->datahoradadevolucao)
			$this->SetFieldAttr('datahoradadevolucao','visible',true);
		else
			$this->SetFieldAttr('datahoradadevolucao','visible',false);
    }


	function getData()
	{
		$data = new FormData();
		$data->idemprestimo = $this->GetFormValue('idemprestimo');
		$data->login = $this->GetFormValue('loginPessoa');
		$data->numerodotombo = $this->GetFormValue('numerodotombo');
		$data->datahoradoemprestimo = $this->GetFormValue('datahoradoemprestimo');
		$data->datahoraprevisaodevolucao = $this->GetFormValue('datahoraprevisaodevolucao');
		$data->datahoradadevolucao = $this->GetFormValue('datahoradadevolucao');
		
		return $data;
	}


	function setData($data)
	{
		$this->SetFieldValue('idemprestimo',$data->idemprestimo);
		$this->SetFieldValue('loginPessoa',$data->login);
		$this->SetFieldValue('numerodotombo', $data->numerodotombo);
		$this->SetFieldValue('datahoradoemprestimo',$data->datahoradoemprestimo);
		$this->SetFieldValue('datahoraprevisaodevolucao',$data->datahoraprevisaodevolucao);
		$this->SetFieldValue('datahoradadevolucao',$data->datahoradadevolucao);
	}


	function btnSalvar_click()
	{
		global $MIOLO,$self,$item,$action,$module;
		$this->objEmprestimo = $MIOLO->GetBusiness($module,'emprestimo');
		$data = $this->getData();
		try
		{
			$result = $this->objEmprestimo->saveEmprestimo($data);

			if($result == true)
			{
				$go = $this->manager->GetActionURL($module, $action,$data->numerodotombo,array('event'=>'btnProcurar:click'));
				$MIOLO->Information("Empréstimo Modificado", $go );
			}
			else
			{
				$this->addError($result);
			}
		}
		catch (Exception $e)
		{
			$this->addError($e->getMessage());
		}
	}
}
?>
