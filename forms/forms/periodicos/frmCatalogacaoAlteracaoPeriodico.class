<?PHP
/* Copyright 2006, 2007, 2008, 2009, 2010 do SETEC/MEC
 *
 * Este arquivo é parte do programa SigaEPT
 *
 * O SigaEPT é um software livre;  você pode redistribuí-lo e/ou modificá-lo dentro dos
 * termos da Licença Pública Geral GNU como publicada pela fundação do software livre (FSF);
 * na versÃ£o 2 da Licença.
 *
 * Este programa é distribuí­do na esperança que possa ser útil, mas SEM NENHUMA GARANTIA; sem
 * uma garantia implícita de ADEQUAÇÃO a qualquer MERCADO ou APLICAÇÃO EM PARTICULAR. Veja Licença
 * Pública Geral GNU/GPL em português para maiores detalhes.
 *
 * Você deve ter recebido uma cópia da Licença Pública Geral GNU, sob o título "LICENCA.txt",
 * junto com este programa, se não, acesse o portal do Software Público Brasileiro no endereço
 * www.softwarepublico.gov.br ou escreva para Fundação do Software Livre (FSF) Inc.,51 Franklin
 * St, Fifth Floor, Boston, MA 02110-1301, USA
 */

?>
<?
class frmCatalogacaoAlteracaoPeriodico extends Form
{

    var $objPeriodico;
    var $objSimples;

    public $periodico;
    public $operacao;
    public $logOperacao;
    public $usuario;
    public $idPeriodico;
    public $material;
    public $assunto;
    
    

    
    function frmCatalogacaoAlteracaoPeriodico()  // construtor da Classe
    {
        global $MIOLO,$module;
//    function __construct($data)
        
        $this->idPeriodico = $data->idperiodico;
            
        //Instancia os objetos
        $this->objPeriodico = $MIOLO->GetBusiness($module,'periodico');
        $this->objSimples = $MIOLO->GetBusiness($module,'pesquisasimples');

        
       // $ideditora = $this->periodico->ideditora;
    //function __construct($item)
         parent::__construct('Alteração do Periódico');
        //$this->SetClose($this->manager->GetActionURL($module, 'main:catalogacao'));
        $this->EventHandler();
    }



    function CreateFields()
    {
        global $MIOLO, $module, $item,$action;

       
   
        $this->periodico = $this->manager->getBusiness('biblioteca','periodico');
        $this->periodico->GetById($item);
    //    $idobra= $this->periodico->GetIdByNumero($item);
        $titulo = $this->periodico->titulo;
        $issn = $this->periodico->issn;
        $ccn =  $this->periodico->ccn;
        $secs = $this->periodico->secs;
        $avaliacaoCapes = $this->periodico->avaliacaoCapes;
        
        $titulo = $this->periodico->titulo;
        $subtitulo = $this->periodico->subtitulo;
        $tituloAbreviado = $this->periodico->tituloAbreviado;
        //$tipoClass = array('CDD','CDU'); //ver se vou fazer

        $editora = $this->periodico->editora; //ver se é o id!
        $modoDeAquisicao = $this->periodico->modoDeAquisicao;
        $assuntos = $this->periodico->assuntos;
        $localizacaoAcessoEletronico = $this->periodico->localizacaoAcessoEletronico;
        $cidade = $this->periodico->cidade;
        $periodicidade = $this->periodico->periodicidade;


        //  TRATANDO CDU E CDD
/*        $cdu = $this->periodico->cdu;
        $cdd = $this->periodico->cdd;
        $cducdd      = '';
        $valorcducdd = '';

        $aa =0;
        if ($cdu != NULL  )
        {
            $cducdd = "CDU";
            $valorcducdd = $cdu;
            $aa=1;
        }
        else
        {
            if ($cdd != NULL  )
            {
                $cducdd = "CDD";
                $valorcducdd = $cdd;
              
            }
        }
*/
                
    $fields = Array (
                    new HiddenField('idPeriodico',$item),
                    new TextField('edtTitulo',$titulo , 'Título',60),
                    new TextField('edtSubtitulo', $subtitulo , 'Subtítulo',60),
                    new TextField('edtTituloAbreviado', $tituloAbreviado , 'Titulo Abreviado',60),
                    new TextField('edtIssn',$issn,'ISSN',20),
                    new TextField('edtCcn',$ccn,'CCN',20),
                    
                    new TextField('edtSecs',$secs,'SECS',9),
                                  new TextField('edtAvaliacaoCapes',$avaliacaoCapes,'Avaliação Capes',20),
                    new LookupTextField('lkpEditora',$editora,'Editora',58,''),
                //new TextField('edtEditora','','Editora',60),
                new LookupTextField('lkpLocalDePublicacao',$cidade,'Local de Publicação',70,'Pesquisar'),
                //new TextField('edtCidade',$cidade,'Cidade',20),
                new TextField('edtModoDeAquisicao',$modoDeAquisicao,'Modo de Aquisição',20),
                new HiddenField('idEditora'),
        //Inclusão CDD e CDU - 30/06/2010
                
         //     new Selection('edtTipo','','Tipo Classificação',array('CDD','CDU')),
       //         new TextField('edtTipo',$cducdd,'Tipo Classificação',10),
       //new TextField('edtCddCdu',$valorcducdd,'Classificação',30),
                new TextField('edtPeriodicidade',$periodicidade,'Periodicidade',20),
                new TextField('edtAssuntos',$assuntos,'Assunto ',40),
                new TextField('edtLocalizacaoAcessoEletronico',$localizacaoAcessoEletronico,'Localização e Acesso Eletrônico',20),
                            
               );
    
    $this->SetFields($fields);
    
  //  $this->SetFieldValue('idPeriodico',$this->periodico->idPeriodico);
    //$this->SetFieldValue('idautor',$this->periodico->idautor);
    
    $this->SetFieldValue('idEditora',$ideditora);

    
    //$this->SetFieldValue('edtTipo',$aa);
             //As 4 propriedades de um lookup

            // module = módulo usado

            // item = A funcao que chama no arquivo classes/lookup.class

            // event = O evento relacionado quando o usuário clica em "acao"

            // related = Os campos retornados após a ação
/*
            $this->SetFieldAttr('lkpautor','module','biblioteca');
            $this->SetFieldAttr('lkpautor','item','autor');                // Metodo
//          $this->SetFieldAttr('lkpautor','event','btnConsulta:click');        

            $this->SetFieldAttr('lkpautor','event','filler');     

            $this->SetFieldAttr('lkpautor','related','idautor,lkpautor,edtCutter');

    

            //Lookup Local de publicacao de obra

            $this->SetFieldAttr('lkpLocalDePublicacao','module','common');
            $this->SetFieldAttr('lkpLocalDePublicacao','item','municipio');
            $this->SetFieldAttr('lkpLocalDePublicacao','event','filler');
            $this->SetFieldAttr('lkpLocalDePublicacao','related','idMunicipio,lkpLocalDePublicacao');

*/
         // 4 propiedades do lookup

        $this->SetFieldAttr('lkpEditora','module','biblioteca');
        $this->SetFieldAttr('lkpEditora','item','editora');
        $this->SetFieldAttr('lkpEditora','event','filler');
//            $this->SetFieldAttr('lkpEditora','event','btnConsulta:click');

        $this->SetFieldAttr('lkpEditora','related', 'ideditora,lkpEditora');

     //Lookup Local de publicacao de obra
             $this->SetFieldAttr('lkpLocalDePublicacao','module','common');
     $this->SetFieldAttr('lkpLocalDePublicacao','item','municipio');
     $this->SetFieldAttr('lkpLocalDePublicacao','event','filler');
     $this->SetFieldAttr('lkpLocalDePublicacao','related','idMunicipio,lkpLocalDePublicacao');
        


            // Insere os campos

                    //$this->SetFields($fields);


            



            // Botões Do formulário 

                    $buttons = Array(
                                     new FormButton('btnAlterar', 'Alterar'),
                //-> 06/07/2010  RETIRADO BOTÃO POIS O MESMO ESTARÁ NO LOOKUP

                // new MButtonWindow('btnAutor', 'Novo Autor', $MIOLO->GetActionURL($module,'main:admin:autor', 'autor', '')),

                                    );
           

                //Comentado dia 02/06/2010 SOLICITADO QUE SE PERMITA CADASTRAR SEM AUTOR

                   //$this->AddValidator(new RequiredValidator('lkpautor'));

  //         $this->AddValidator(new RequiredValidator('edtCutter'));
           $this->AddValidator(new RequiredValidator('lkpEditora'));
            //Insere os Botões
                    
                    $this->SetButtons($buttons);

                    
            //Definindo o foco

            if (!($this->GetFieldValue('edtTitulo')))
            {
                $this->page->onLoad("MIOLO_GetElementById('edtTitulo').focus();");
            }

            

    }
//}



function GetData()
{
    $data = new FormData();
        $data->idPeriodico = $this->periodico->idPeriodico;
        $data->titulo = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtTitulo')));
        $data->subtitulo = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtSubtitulo')));
        $data->tituloAbreviado = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtTituloAbreviado')));
        //Aqui!
        $data->issn = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtIssn')));
        $data->ccn = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtCcn')));
		$data->secs = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtSecs')));
		
        $data->avaliacaoCapes = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtAvaliacaoCapes')));
		$data->idEditora = ($this->GetFieldValue('idEditora'));
		$data->nomeEditora = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('lkpEditora')));
        $data->cidade = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('lkpLocalDePublicacao')));
        $data->modoDeAquisicao = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtModoDeAquisicao')));
		$data->assuntos = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtAssuntos')));
        $data->localizacaoAcessoEltronico = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtLocalizacaoAcessoEletronico')));
        $data->periodicidade = trim($this->objSimples->RetirarCaracteresEspeciais($this->GetFieldValue('edtPeriodicidade')));
        
  //Inclusão CDD e CDU

         // $data->keytipo = $this->objSimples->$this->GetFieldValue('selClass');
          
/*
  //  Preenche o Tipo de Classificação CDD ou CDU   01/07/2010

  $data->idgenero = 1;   // rever
  $data->tipoclassificacao = $this->GetFieldValue('edtTipo');
  $data->cdu = $this->GetFieldValue('edtCddCdu');
  $data->cdd = $this->GetFieldValue('edtCddCdu');
  $data->isbn = $this->GetFieldValue('edtISBN');
  //var_dump($this->GetFieldValue('ideditora'));
 
  */
          
  return $data;
}


// usada para inserir valores no formulário

        function SetData($data)
{
        $this->SetFieldValue('edtCutter',$data->cutter);
        $this->SetFieldValue('idautor',$data->idautor);     //
        $this->SetFieldValue('ideditora',$data->ideditora);
        $this->SetFieldValue('lkpEditora',$data->descricao);
        $this->SetFieldValue('edtISBN',$data->isbn);

        
        
}



    // Alterar dados
            
      function btnAlterar_click($data)
{
    global $MIOLO,$module;

    $data = $this->GetData();

        //já grava o 008 na pré-catalogação
        $ficha008 = date('ymd') . '                 r               d';

        //var_dump($data);
        try
        {

            $this->objPeriodico->update($data);
           

           // $this->objObra->saveSubFicha($ficha008, '008');
            $msg = "Periódico " . $data->titulo . " alterada com sucesso.";


           $MIOLO->Prompt(Prompt::Information($msg,$MIOLO->GetActionURL($module,'main:catalogacao:periodicos:catalogacaoperiodico', $data->idPeriodico, ''),$this->listURL));

            

            //$MIOLO->GetActionURL($module,'main:admin:autor', 'autor', '')
////$lookup->AddFilterField( new MButtonWindow('btnMarc', 'MARC', $MIOLO->GetActionURL($module = $module, 'marc', $this->idAutor)));
                   
            
        }
        catch (Exception $e)
        {
            $this->addError($e->getMessage());
        }


}




    
}
?>
